---
title: 'Configurer un relais SMTP'
---

import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';

Si votre fournisseur d'accès à Internet bloque le port 25, ou si vous rencontrez un problème d’utilisation du serveur SMTP natif de YunoHost, vous pouvez configurer votre serveur YunoHost pour utiliser un relais SMTP.

## Qu'est-ce qu'un relais SMTP ?

C'est un serveur SMTP tiers qui va envoyer les e-mails aux destinataires à la place de votre propre serveur SMTP.
Une fois correctement installé, le fonctionnement est transparent pour l’utilisateur. Vos correspondants verront vos e-mails comme s’ils venaient de votre propre serveur, mais ils seront passés par le relais SMTP que vous aurez choisis et configurés.

## <FAIcon icon="fa-exclamation-triangle"/>  Inconvénients des relais SMTP

Il est important de noter que dans le monde de l'auto-hébergement, utiliser un relais SMTP est un énorme compromis ! En effet, le relais SMTP sera non seulement capable d'envoyer les e-mails de votre part, mais il a également accès au contenu intégral de vos e-mails et peut éventuellement les modifier (Par exemple, par défaut, MailJet réécrit les hyperliens html contenus dans vos mails, afin de traquer l'activité de vos correspondants). Il faut également savoir qu'une fois mis en place, tout le trafic e-mail sortant de votre serveur passera par ce relais ; il n'est pas possible de choisir de l'utiliser ou pas selon l'expéditeur ou la destination.

Au-delà des considérations de confidentialité ci-dessus, un relais SMTP peut imposer des limitations techniques que l'on n'aurait pas si le port 25 était ouvert. Par exemple, avec la plupart des relais, si un utilisateur de votre serveur YunoHost déclare **une "adresse de transfert" extérieure** dans le but de transférer automatiquement les messages reçus sur votre serveur YunoHost vers une autre boîte mail, **ce transfert ne fonctionnera pas** pour les courriels venant de l'extérieur de votre serveur, sans qu'il soit en averti. En effet, les relais exigent généralement que les messages qu'ils transmettent aient une adresse d'expéditeur de votre domaine (pour lutter contre le spam et préserver la réputation de leurs services), ce qui n'est pas le cas pour un "forward automatique" où l'expéditeur originel du mail est conservé ; le message est alors bloqué par le relais (qui, normalement, prévient votre admin YunoHost, mais seulement après coup).

## Comment utiliser un relais SMTP avec YunoHost ?

YunoHost supporte depuis la version 4.1 la configuration d'un relais SMTP. Pour le moment cette fonctionnalité n'est pas accessible depuis l'interface d'administration : le paramétrage doit être fait en ligne de commande.

### Étape 1 : S'inscrire chez un fournisseur de relais SMTP

Beaucoup de fournisseurs existent dans ce domaine. Certains sont gratuits et d'autres proposent des services payants contre différentes options. Comme écrit plus haut, vous devez être sûr de pouvoir lui faire confiance, mais cela reste à votre entier égard.

### Étape 2 : Paramétrer sa zone DNS correctement

Once registered, the SMTP relay provider will usually ask you to modify your DNS.
Standard procedure is to add a DKIM key and a SPF key to your DNS records.
The way to modify these records and the value of the keys you'll have to add depend both on your domain name provider and SMTP relay provider.

Usually, the SMTP relay provider will provide you with a guide on how to modify these records, together with an automatic check tool that will tell you when your DNS have been setup correctly. That step is mandatory to prove "the world" that you, owner of your domain name, did explicitly authorize your SMTP relay provider to send emails on your behalf.

Please note that modifying your DNS records could sometimes take over 24h to take effect, so be patient!

:::warning
<FAIcon icon="fa-exclamation-triangle"/> Attention une fois la zone DNS enregistrée, le relais SMTP peut envoyer des e-mails à votre nom sans que vous ne le sachiez
:::

### Étape 3 : Configurer YunoHost correctement

Il est possible de configurer soit via la webadmin ou en ligne de commande.

<Tabs groupId="admin-commands">
<TabItem value="web" label="Depuis la webadmin">

Depuis l'interface d'administration, dans la section `Outils` > `Paramètres de YunoHost`, et l'onglet `Email`.
Il suffit d'activer l'option, et de renseigner les champs nécessaires :

- **SMTP relay host** : SMTP server url.
- **SMTP relay port** : Port use with the distant server.
- **SMTP relay user** : Login or identification mail server.
- **SMTP relay password** : Your SMTP relay password.

:::warning
<FAIcon icon="fa-exclamation-triangle"/>  Les mots de passe avec le caractère `#` ne fonctionneront pas proprement à cause d'une limitation de postfix (d'autres caractères sont peut-être interdit, n'hésitez pas à rapporter ce genre de cas pour la mise à jour de cette doc).
:::

![Option-Relais-Smtp](/img/webadmin/relay_smtp_option_webadmin_en.png)

</TabItem>
<TabItem value="cli" label="Depuis la ligne de commande">

Pour que YunoHost soit capable d'utiliser le relais, il faut paramétrer 4 choses.

1. Your SMTP relay URL (for this tutorial we will use `smtprelay.tld`)
2. The port on which you access the relay (for this tutorial we will use port 2525 below)
3. Your SMTP relay username (for this tutorial we will use `username`)
4. Your SMTP relay password (for this tutorial we will use `password`)

:::warning
<FAIcon icon="fa-exclamation-triangle"/>  Les mots de passe avec le caractère `#` ne fonctionneront pas proprement à cause d'une limitation de postfix (d'autres caractères sont peut-être interdit, n'hésitez pas à rapporter ce genre de cas pour la mise à jour de cette doc).
:::

Le fournisseur SMTP vous fournit ces trois informations.

Premièrement se connecter sur son serveur en SSH avec la commande :

```bash
ssh admin@yourdomain.tld
```

Ensuite, mettre à jour les informations suivantes :

```bash
sudo yunohost settings set email.smtp.smtp_relay_enabled -v yes
sudo yunohost settings set smtp.relay.host -v smtprelay.tld
sudo yunohost settings set smtp.relay.port -v 2525
sudo yunohost settings set smtp.relay.user -v username
sudo yunohost settings set smtp.relay.password -v password
```

C'est une bonne idée de confirmer les informations en faisant :

```bash
sudo yunohost settings list
```

</TabItem>
</Tabs>

Votre relais SMTP est maintenant configuré !

:::warning
<FAIcon icon="fa-exclamation-triangle"/> Maintenant le relais SMTP est capable de lire et d'utiliser toutes les informations contenues dans les emails que vous envoyez sans votre accord. Mais il ne sera pas capable de lire les informations des emails que vous recevez.
:::

#### Relayer tous les emails même ceux des noms de domaines gérés par YunoHost

Si vous avez une grande confiance dans votre relais SMTP, que vous avez un second serveur IMAP que vous souhaitez ou êtes contraint d'utiliser en lieu et place de celui de YunoHost, vous pouvez choisir de relayer tous les emails même ceux des noms de domaines gérés par YunoHost en commentant les deux ligne suivantes dans `/etc/postfix/main.cf` :

```text
#virtual_mailbox_domains = ldap:/etc/postfix/ldap-domains.cf
#virtual_alias_maps = ldap:/etc/postfix/ldap-aliases.cf,ldap:/etc/postfix/ldap-groups.cf
```

### Étape 4 : Vérifier la configuration

You can check your setup by sending emails and try if everything works.
Some of the SMTP relay will give you insights about the emails you send so that can also be a good way to check that everythings works as needed.
Of course, you can always have a try with [mail-tester.com](https://www.mail-tester.com/) to check for any problem or discrepancy.
