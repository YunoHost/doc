"use strict";(self.webpackChunkyunohost_docs=self.webpackChunkyunohost_docs||[]).push([["6461"],{7633:function(e,s,t){t.r(s),t.d(s,{frontMatter:()=>i,toc:()=>d,default:()=>p,metadata:()=>a,assets:()=>h,contentTitle:()=>c});var a=JSON.parse('{"id":"admin/backups/clone_filesystem","title":"Snapshotting the entire filesystem","description":"YunoHost\'s backup tool only backs up useful files and relies on restore scripts to reinstall the dependencies of your applications. In other words, YunoHost\'s mechanism amounts to reinstalling and then reincorporating the data.","source":"@site/docs/admin/40.backups/15.clone_filesystem.mdx","sourceDirName":"admin/40.backups","slug":"/admin/backups/clone_filesystem","permalink":"/doc/pr-2675/oc/admin/backups/clone_filesystem","draft":false,"unlisted":false,"editUrl":"https://github.com/YunoHost/doc/tree/main/docs/admin/40.backups/15.clone_filesystem.mdx","tags":[],"version":"current","sidebarPosition":15,"frontMatter":{"title":"Snapshotting the entire filesystem"},"sidebar":"admin","previous":{"title":"Backup methods","permalink":"/doc/pr-2675/oc/admin/backups/backup_methods"},"next":{"title":"Avoid hardware failure","permalink":"/doc/pr-2675/oc/admin/backups/avoid_hardware_failure"}}'),n=t(4848),o=t(4429),r=t(4109),l=t(3703);let i={title:"Snapshotting the entire filesystem"},c,h={},d=[{value:"Creating a snapshot",id:"creating-a-snapshot",level:2},{value:"Create a cold image of the file system",id:"create-a-cold-image-of-the-file-system",level:2}];function u(e){let s={a:"a",admonition:"admonition",code:"code",h2:"h2",img:"img",li:"li",p:"p",pre:"pre",ul:"ul",...(0,o.R)(),...e.components};return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(s.p,{children:"YunoHost's backup tool only backs up useful files and relies on restore scripts to reinstall the dependencies of your applications. In other words, YunoHost's mechanism amounts to reinstalling and then reincorporating the data."}),"\n",(0,n.jsx)(s.p,{children:"Making full system images can be a complementary or alternative way to backup your machine. The advantage is that your system can be restored to the exact state it was in at the time of the backup."}),"\n",(0,n.jsx)(s.p,{children:"Depending on your type of installation, you can either create a snapshot or clone the storage medium by removing it from your server (turned off)."}),"\n",(0,n.jsx)(s.h2,{id:"creating-a-snapshot",children:"Creating a snapshot"}),"\n",(0,n.jsx)(s.p,{children:"A snapshot allows you to freeze an image of the file system. Snapshots are very useful when doing an update or testing, because they allow you to easily go back in case of a glitch. On the other hand, apart from some very high availability clusters, snapshots do not really protect you against hardware failures or disasters (cf. OVH fire in Strasbourg in 2021)."}),"\n",(0,n.jsx)(s.p,{children:"In general, snapshots are quite disk space saving, the principle is that your file system will store the differences that occurred since your snapshot. Thus, only the modifications consume space."}),"\n",(0,n.jsx)(s.admonition,{type:"info",children:(0,n.jsx)(s.p,{children:"Remember to delete the old snapshots to avoid wasting your storage space by storing all the differences since that date!"})}),"\n",(0,n.jsx)(s.p,{children:"You can use this method with most VPS (often paying), virtual machine managers or if you have installed YunoHost with an advanced filesystem like btrfs, ceph or ZFS, you can also create snapshots via the command line"}),"\n",(0,n.jsxs)(r.A,{children:[(0,n.jsxs)(l.A,{value:"vps",label:"VPS",children:[(0,n.jsx)(s.p,{children:"Below, some documentation for the most known suppliers:"}),(0,n.jsxs)(s.ul,{children:["\n",(0,n.jsx)(s.li,{children:(0,n.jsx)(s.a,{href:"https://docs.digitalocean.com/products/images/snapshots/",children:"DigitalOcean (EN)"})}),"\n",(0,n.jsx)(s.li,{children:(0,n.jsx)(s.a,{href:"https://docs.gandi.net/fr/simple_hosting/operations_courantes/snapshots.html",children:"Gandi"})}),"\n",(0,n.jsx)(s.li,{children:(0,n.jsx)(s.a,{href:"https://docs.ovh.com/fr/vps/snapshot-vps/",children:"OVH"})}),"\n",(0,n.jsx)(s.li,{children:(0,n.jsx)(s.a,{href:"https://www.scaleway.com/en/docs/backup-your-data-with-snapshots/",children:"Scaleway (EN)"})}),"\n"]})]}),(0,n.jsxs)(l.A,{value:"virtualbox",label:"VirtualBox",children:[(0,n.jsxs)(s.p,{children:["Select the virtual machine and click ",(0,n.jsx)(s.code,{children:"Snapshots"}),", then specify the snapshot name and click ",(0,n.jsx)(s.code,{children:"OK"}),".\n",(0,n.jsx)(s.img,{alt:"The snapshot button is located at the top right",src:t(9361).A+"",width:"720",height:"381"})]}),(0,n.jsxs)(s.p,{children:["To restore, select the virtual machine, click on ",(0,n.jsx)(s.code,{children:"Snapshots"})," then ",(0,n.jsx)(s.code,{children:"Restore Snapshot option"}),".\n",(0,n.jsx)(s.img,{src:t(486).A+"",width:"719",height:"366"})]}),(0,n.jsxs)(s.p,{children:["Then click on ",(0,n.jsx)(s.code,{children:"Restore Snapshot"}),".\n",(0,n.jsx)(s.img,{src:t(7883).A+"",width:"720",height:"381"})]})]}),(0,n.jsx)(l.A,{value:"proxmox",label:"Proxmox",children:(0,n.jsxs)(s.ul,{children:["\n",(0,n.jsx)(s.li,{children:"Select the virtual machine"}),"\n",(0,n.jsxs)(s.li,{children:["Go to the ",(0,n.jsx)(s.code,{children:"Backup"})," tab"]}),"\n",(0,n.jsxs)(s.li,{children:["Click on ",(0,n.jsx)(s.code,{children:"Backup now"}),"."]}),"\n",(0,n.jsxs)(s.li,{children:["Choose ",(0,n.jsx)(s.code,{children:"Snapshot"})," mode"]}),"\n",(0,n.jsx)(s.li,{children:"Validate"}),"\n"]})}),(0,n.jsxs)(l.A,{value:"btrfs",label:"BTRFS",children:[(0,n.jsxs)(s.p,{children:["Below we consider that ",(0,n.jsx)(s.code,{children:"/pool/volume"})," is the volume to snapshot."]}),(0,n.jsx)(s.p,{children:"Create a read-only snapshot"}),(0,n.jsx)(s.pre,{children:(0,n.jsx)(s.code,{className:"language-bash",children:'btrfs subvolume snapshot /pool/volume /pool/volume/$(date +"%Y-%m-%d_%H:%M")\n'})}),(0,n.jsx)(s.p,{children:"List snapshots"}),(0,n.jsx)(s.pre,{children:(0,n.jsx)(s.code,{className:"language-bash",children:"btrfs subvolume show /pool/volume\n"})}),(0,n.jsx)(s.p,{children:"Restore a snapshot"}),(0,n.jsx)(s.pre,{children:(0,n.jsx)(s.code,{className:"language-bash",children:"btrfs sub del /pool/volume\nbtrfs sub snap /pool/volume/2021-07-22_16:12 /pool/volume\nbtrfs sub del /pool/volume/2021-07-22_16:12\n"})}),(0,n.jsx)(s.p,{children:"Delete a snapshot"}),(0,n.jsx)(s.pre,{children:(0,n.jsx)(s.code,{className:"language-bash",children:"btrfs subvolume delete /pool/volume/2021-07-22_16:12\n"})}),(0,n.jsx)(s.admonition,{type:"caution",children:(0,n.jsx)(s.p,{children:"Be careful not to delete the original volume"})}),(0,n.jsx)(s.admonition,{type:"tip",children:(0,n.jsxs)(s.p,{children:["See ",(0,n.jsx)(s.a,{href:"https://www.linux.com/training-tutorials/how-create-and-manage-btrfs-snapshots-and-rollbacks-linux-part-2/",children:"this tutorial"})," for more info"]})})]}),(0,n.jsxs)(l.A,{value:"ceph",label:"CEPH",children:[(0,n.jsxs)(s.p,{children:["Below we consider that ",(0,n.jsx)(s.code,{children:"pool/volume"})," is the volume to snapshot."]}),(0,n.jsx)(s.p,{children:"Create a snapshot"}),(0,n.jsx)(s.pre,{children:(0,n.jsx)(s.code,{className:"language-bash",children:'rbd snap create pool/volume@$(date +"%Y-%m-%d_%H:%M")\n'})}),(0,n.jsx)(s.p,{children:"List snapshots"}),(0,n.jsx)(s.pre,{children:(0,n.jsx)(s.code,{className:"language-bash",children:"rbd snap ls pool/volume\n"})}),(0,n.jsx)(s.p,{children:"Restore a snapshot"}),(0,n.jsx)(s.pre,{children:(0,n.jsx)(s.code,{className:"language-bash",children:"rbd snap rollback pool/volume@2021-07-22_16:22\n"})}),(0,n.jsx)(s.p,{children:"Delete a snapshot"}),(0,n.jsx)(s.pre,{children:(0,n.jsx)(s.code,{className:"language-bash",children:"rbd snap rm pool/volume@2021-07-22_16:12\n"})})]}),(0,n.jsxs)(l.A,{value:"zfs",label:"ZFS",children:[(0,n.jsxs)(s.p,{children:["Below we consider that ",(0,n.jsx)(s.code,{children:"pool/volume"})," is the volume to snapshot."]}),(0,n.jsx)(s.p,{children:"Create a snapshot"}),(0,n.jsx)(s.pre,{children:(0,n.jsx)(s.code,{className:"language-bash",children:'zfs snapshot pool/volume@$(date +"%Y-%m-%d_%H:%M")\n'})}),(0,n.jsx)(s.p,{children:"List snapshots"}),(0,n.jsx)(s.pre,{children:(0,n.jsx)(s.code,{className:"language-bash",children:"zfs list -t snapshot -o name,creation\n"})}),(0,n.jsx)(s.p,{children:"Restore a snapshot"}),(0,n.jsx)(s.pre,{children:(0,n.jsx)(s.code,{className:"language-bash",children:"zfs rollback pool/volume@2021-07-22_16:22\n"})}),(0,n.jsx)(s.p,{children:"Delete a snapshot"}),(0,n.jsx)(s.pre,{children:(0,n.jsx)(s.code,{className:"language-bash",children:"zfs destroy pool/volume@2021-07-22_16:12\n"})})]})]}),"\n",(0,n.jsx)(s.h2,{id:"create-a-cold-image-of-the-file-system",children:"Create a cold image of the file system"}),"\n",(0,n.jsx)(s.p,{children:"You can clone your media (SD card, ssd disk, VPS volume...) to create a disk image. This image before compression will be the exact size of your media, that's why this method applies rather to machines of less than 64GB."}),"\n",(0,n.jsx)(s.p,{children:"Unless you can read a snapshot, this method requires you to stop the server while you create the image. With a VPS, you have to restart in rescue mode from your provider's interface."}),"\n",(0,n.jsxs)(r.A,{children:[(0,n.jsxs)(l.A,{value:"usbimage",label:"With USBimager",children:[(0,n.jsxs)(s.p,{children:["This can be done with ",(0,n.jsx)(s.a,{href:"https://bztsrc.gitlab.io/usbimager/",children:"USBimager"})," (Note: make sure you download the 'Read-write' version! Not the 'Write-only' version!). The process then consists of the \"reverse\" of the SD card flashing process:"]}),(0,n.jsxs)(s.ul,{children:["\n",(0,n.jsx)(s.li,{children:"Turn off your server"}),"\n",(0,n.jsx)(s.li,{children:"Retrieve the SD card and plug it into your computer"}),"\n",(0,n.jsx)(s.li,{children:'In USBimager, click on "Read" to create an image ("photograph") of the SD card. You can use the resulting file to restore the whole system later.'}),"\n"]}),(0,n.jsxs)(s.p,{children:["More details in ",(0,n.jsx)(s.a,{href:"https://gitlab.com/bztsrc/usbimager/#creating-backup-image-file-from-device",children:"USBimager documentation"})]})]}),(0,n.jsxs)(l.A,{value:"dd",label:"In command line with dd",children:[(0,n.jsxs)(s.p,{children:["It is possible to achieve the same thing with ",(0,n.jsx)(s.code,{children:"dd"})," if you are comfortable with the command line:"]}),(0,n.jsx)(s.pre,{children:(0,n.jsx)(s.code,{className:"language-bash",children:"dd if=/dev/mmcblk0 | gzip > ./my_snapshot.gz\n"})}),(0,n.jsxs)(s.p,{children:["(replace ",(0,n.jsx)(s.code,{children:"/dev/mmcblk0"})," with the real name of your SD card or hard drive)"]})]})]})]})}function p(e={}){let{wrapper:s}={...(0,o.R)(),...e.components};return s?(0,n.jsx)(s,{...e,children:(0,n.jsx)(u,{...e})}):u(e)}},9361:function(e,s,t){t.d(s,{A:()=>a});let a=t.p+"assets/images/virtualbox-snapshot2-8b23f84615e0a99e43d2636c70d33a5d.webp"},486:function(e,s,t){t.d(s,{A:()=>a});let a=t.p+"assets/images/virtualbox-snapshot3-08a179ce073e3326be3cbd1880a89b44.webp"},7883:function(e,s,t){t.d(s,{A:()=>a});let a=t.p+"assets/images/virtualbox-snapshot4-5153c257e34ee578c19f1e044bd0ab85.webp"},3703:function(e,s,t){t.d(s,{A:()=>o});var a=t(4848);t(6540);var n=t(9836);function o({children:e,hidden:s,className:t}){return(0,a.jsx)("div",{role:"tabpanel",className:(0,n.A)("tabItem_Ymn6",t),hidden:s,children:e})}},4109:function(e,s,t){t.d(s,{A:()=>g});var a=t(4848),n=t(6540),o=t(9836),r=t(6364),l=t(8251),i=t(6347),c=t(8004),h=t(5580),d=t(2213),u=t(5734);function p(e){return n.Children.toArray(e).filter(e=>"\n"!==e).map(e=>{if(!e||(0,n.isValidElement)(e)&&function(e){let{props:s}=e;return!!s&&"object"==typeof s&&"value"in s}(e))return e;throw Error(`Docusaurus error: Bad <Tabs> child <${"string"==typeof e.type?e.type:e.type.name}>: all children of the <Tabs> component should be <TabItem>, and every <TabItem> should have a unique "value" prop.`)})?.filter(Boolean)??[]}function m({value:e,tabValues:s}){return s.some(s=>s.value===e)}var f=t(8864);function x({className:e,block:s,selectedValue:t,selectValue:n,tabValues:r}){let i=[],{blockElementScrollPositionUntilNextRender:c}=(0,l.a_)(),h=e=>{let s=e.currentTarget,a=r[i.indexOf(s)].value;a!==t&&(c(s),n(a))},d=e=>{let s=null;switch(e.key){case"Enter":h(e);break;case"ArrowRight":{let t=i.indexOf(e.currentTarget)+1;s=i[t]??i[0];break}case"ArrowLeft":{let t=i.indexOf(e.currentTarget)-1;s=i[t]??i[i.length-1]}}s?.focus()};return(0,a.jsx)("ul",{role:"tablist","aria-orientation":"horizontal",className:(0,o.A)("tabs",{"tabs--block":s},e),children:r.map(({value:e,label:s,attributes:n})=>(0,a.jsx)("li",{role:"tab",tabIndex:t===e?0:-1,"aria-selected":t===e,ref:e=>{i.push(e)},onKeyDown:d,onClick:h,...n,className:(0,o.A)("tabs__item","tabItem_LNqP",n?.className,{"tabs__item--active":t===e}),children:s??e},e))})}function b({lazy:e,children:s,selectedValue:t}){let r=(Array.isArray(s)?s:[s]).filter(Boolean);if(e){let e=r.find(e=>e.props.value===t);return e?(0,n.cloneElement)(e,{className:(0,o.A)("margin-top--md",e.props.className)}):null}return(0,a.jsx)("div",{className:"margin-top--md",children:r.map((e,s)=>(0,n.cloneElement)(e,{key:s,hidden:e.props.value!==t}))})}function j(e){let s=function(e){let s,{defaultValue:t,queryString:a=!1,groupId:o}=e,r=function(e){let{values:s,children:t}=e;return(0,n.useMemo)(()=>{let e=s??p(t).map(({props:{value:e,label:s,attributes:t,default:a}})=>({value:e,label:s,attributes:t,default:a})),a=(0,d.XI)(e,(e,s)=>e.value===s.value);if(a.length>0)throw Error(`Docusaurus error: Duplicate values "${a.map(e=>e.value).join(", ")}" found in <Tabs>. Every value needs to be unique.`);return e},[s,t])}(e),[l,f]=(0,n.useState)(()=>(function({defaultValue:e,tabValues:s}){if(0===s.length)throw Error("Docusaurus error: the <Tabs> component requires at least one <TabItem> children component");if(e){if(!m({value:e,tabValues:s}))throw Error(`Docusaurus error: The <Tabs> has a defaultValue "${e}" but none of its children has the corresponding value. Available values are: ${s.map(e=>e.value).join(", ")}. If you intend to show no default tab, use defaultValue={null} instead.`);return e}let t=s.find(e=>e.default)??s[0];if(!t)throw Error("Unexpected error: 0 tabValues");return t.value})({defaultValue:t,tabValues:r})),[x,b]=function({queryString:e=!1,groupId:s}){let t=(0,i.W6)(),a=function({queryString:e=!1,groupId:s}){if("string"==typeof e)return e;if(!1===e)return null;if(!0===e&&!s)throw Error('Docusaurus error: The <Tabs> component groupId prop is required if queryString=true, because this value is used as the search param name. You can also provide an explicit value such as queryString="my-search-param".');return s??null}({queryString:e,groupId:s});return[(0,h.aZ)(a),(0,n.useCallback)(e=>{if(!a)return;let s=new URLSearchParams(t.location.search);s.set(a,e),t.replace({...t.location,search:s.toString()})},[a,t])]}({queryString:a,groupId:o}),[j,g]=function({groupId:e}){let s=e?`docusaurus.tab.${e}`:null,[t,a]=(0,u.Dv)(s);return[t,(0,n.useCallback)(e=>{s&&a.set(e)},[s,a])]}({groupId:o}),v=m({value:s=x??j,tabValues:r})?s:null;return(0,c.A)(()=>{v&&f(v)},[v]),{selectedValue:l,selectValue:(0,n.useCallback)(e=>{if(!m({value:e,tabValues:r}))throw Error(`Can't select invalid tab value=${e}`);f(e),b(e),g(e)},[b,g,r]),tabValues:r}}(e);return(0,a.jsxs)("div",{className:(0,o.A)(r.G.tabs.container,"tabs-container","tabList__CuJ"),children:[(0,a.jsx)(x,{...s,...e}),(0,a.jsx)(b,{...s,...e})]})}function g(e){let s=(0,f.A)();return(0,a.jsx)(j,{...e,children:p(e.children)},String(s))}},4429:function(e,s,t){t.d(s,{R:()=>r,x:()=>l});var a=t(6540);let n={},o=a.createContext(n);function r(e){let s=a.useContext(o);return a.useMemo(function(){return"function"==typeof e?e(s):{...s,...e}},[s,e])}function l(e){let s;return s=e.disableParentContext?"function"==typeof e.components?e.components(n):e.components||n:r(e.components),a.createElement(o.Provider,{value:s},e.children)}}}]);