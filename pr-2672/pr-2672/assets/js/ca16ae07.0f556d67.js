"use strict";(self.webpackChunkyunohost_docs=self.webpackChunkyunohost_docs||[]).push([["7672"],{1712:function(e,i,n){n.r(i),n.d(i,{frontMatter:()=>o,toc:()=>c,default:()=>h,metadata:()=>t,assets:()=>d,contentTitle:()=>r});var t=JSON.parse('{"id":"packaging/advanced/packaging_v2","title":"Packaging v2","description":"Packaging v2 is a major improvement for the packaging introduced in YunoHost 11.1","source":"@site/docs/packaging/60.advanced/70.packaging_v2.mdx","sourceDirName":"packaging/60.advanced","slug":"/packaging/advanced/packaging_v2","permalink":"/pr-2672/packaging/advanced/packaging_v2","draft":false,"unlisted":false,"editUrl":"https://github.com/YunoHost/doc/tree/main/docs/packaging/60.advanced/70.packaging_v2.mdx","tags":[],"version":"current","sidebarPosition":70,"frontMatter":{"title":"Packaging v2"},"sidebar":"devpackaging","previous":{"title":"Advanced packagers","permalink":"/pr-2672/packaging/advanced/advanced_packagers"},"next":{"title":"Misc resources","permalink":"/pr-2672/category/misc-resources"}}'),s=n(4848),a=n(4429);let o={title:"Packaging v2"},r,d={},c=[{value:"Motivation",id:"motivation",level:3},{value:"Adapting a v1 app to v2",id:"adapting-a-v1-app-to-v2",level:3},{value:"Highlights of the new format",id:"highlights-of-the-new-format",level:3}];function l(e){let i={a:"a",code:"code",em:"em",h3:"h3",li:"li",p:"p",strong:"strong",ul:"ul",...(0,a.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(i.p,{children:"Packaging v2 is a major improvement for the packaging introduced in YunoHost 11.1"}),"\n",(0,s.jsx)(i.h3,{id:"motivation",children:"Motivation"}),"\n",(0,s.jsx)(i.p,{children:"The motivations for this new format is:"}),"\n",(0,s.jsxs)(i.ul,{children:["\n",(0,s.jsx)(i.li,{children:"to get rid of some boring or unecessarily complex or duplicateds stuff such as saving/loading settings, creating a system user, etc.. during the install/upgrade/restore script, which are common things accross many apps."}),"\n",(0,s.jsxs)(i.li,{children:["to get rid of funky historical, not-super-semantic stuff such as ",(0,s.jsx)(i.code,{children:"__FINALPATH__"})," being replaced by ",(0,s.jsx)(i.code,{children:"$final_path"})," (with underscore), or ",(0,s.jsx)(i.code,{children:"__PATH__"})," being replaced by ",(0,s.jsx)(i.code,{children:"$path_url"}),", etc."]}),"\n",(0,s.jsx)(i.li,{children:"formalize some aspects such as the existence of the install dir, data dir, apt dependencies, database, etc. which in turn unlock possible future developments such as computing the space used by an app at one given moment, auto-upgrading apt dependencies during Debian major migration, etc."}),"\n",(0,s.jsxs)(i.li,{children:["formalize some meta-info such as LDAP/SSO support, architectures supports, and other pre-install / post-install, pre-upgrade / post-upgrade notifications (replacing the infamous ",(0,s.jsx)(i.code,{children:"ynh_send_readme_to_admin"}),") for better UI/UX during the install and upgrade process."]}),"\n"]}),"\n",(0,s.jsx)(i.p,{children:'However, this "v2" is not the end of the story and should be seen as an intermediate stage before a "v3" packaging. In particular this "v3" packaging should also formalize the handling of the system and app configurations files and ultimately rework the entire paradigm of the install/remove/upgrade/backup/restore scripts.'}),"\n",(0,s.jsx)(i.h3,{id:"adapting-a-v1-app-to-v2",children:"Adapting a v1 app to v2"}),"\n",(0,s.jsxs)(i.p,{children:["A script is available in ",(0,s.jsx)(i.a,{href:"https://github.com/YunoHost/apps_tools/tree/main/packaging_v2",children:"the apps_tools repository"})," and will attempt to convert what it can from the v1 format to the v2 format, in particular:"]}),"\n",(0,s.jsxs)(i.ul,{children:["\n",(0,s.jsxs)(i.li,{children:["initializing a ",(0,s.jsx)(i.code,{children:"manifest.toml"})," and prefilling it with info scrapped from the various scripts"]}),"\n",(0,s.jsx)(i.li,{children:"comment out now-unecessary lines in the various scripts"}),"\n"]}),"\n",(0,s.jsxs)(i.p,{children:["Usage: ",(0,s.jsx)(i.code,{children:"python3 convert_app_to_packaging_v2.py /path/yo/your/app"})]}),"\n",(0,s.jsx)(i.p,{children:"This will edit the file in place and you should then carefully review and iterate over what the script did for you."}),"\n",(0,s.jsx)(i.h3,{id:"highlights-of-the-new-format",children:"Highlights of the new format"}),"\n",(0,s.jsxs)(i.p,{children:["The ",(0,s.jsx)(i.a,{href:"https://github.com/YunoHost/example_ynh",children:"example repo"})," illustrates the below."]}),"\n",(0,s.jsxs)(i.ul,{children:["\n",(0,s.jsxs)(i.li,{children:[(0,s.jsxs)(i.strong,{children:["The manifest is now written as toml (",(0,s.jsx)(i.code,{children:"manifest.toml"}),")"]})," instead of json (",(0,s.jsx)(i.code,{children:"manifest.json"}),"). The structure of the manifest itself has been reworked and now include:","\n",(0,s.jsxs)(i.ul,{children:["\n",(0,s.jsxs)(i.li,{children:["The ",(0,s.jsx)(i.code,{children:"upstream"})," section (now mandatory)"]}),"\n",(0,s.jsxs)(i.li,{children:["An ",(0,s.jsx)(i.code,{children:"integration"})," section meant to formalize what minimum YunoHost version is required, the list of supported architectures, declare if SSO/LDAP is supported, typical resource usage. This is meant to be displayed both in the catalog (similar to app stores) and on the app info page after installing the app - though this is still work in progress."]}),"\n",(0,s.jsxs)(i.li,{children:["A ",(0,s.jsx)(i.code,{children:"resource"})," section (detailed below)"]}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(i.li,{children:[(0,s.jsx)(i.strong,{children:"Install questions are now automatically saved as settings"})," (except user-provided password and other specific infos)"]}),"\n",(0,s.jsxs)(i.li,{children:[(0,s.jsx)(i.strong,{children:"All settings are now automatically loaded in app script environments"})," (so e.g. directly define ",(0,s.jsx)(i.code,{children:"$domain"}),", etc.)"]}),"\n",(0,s.jsxs)(i.li,{children:[(0,s.jsxs)(i.strong,{children:["Auto-enable ",(0,s.jsx)(i.code,{children:"set -eu"})]})," a.k.a. ",(0,s.jsx)(i.code,{children:"ynh_abort_if_errors"})," in appropriate scripts"]}),"\n",(0,s.jsx)(i.li,{children:(0,s.jsx)(i.strong,{children:"The safety-backup-before-upgrade is now automatically handled by the core"})}),"\n",(0,s.jsxs)(i.li,{children:[(0,s.jsx)(i.strong,{children:"Simplify writing change-url scripts"}),": old the ",(0,s.jsx)(i.code,{children:"new"}),"/",(0,s.jsx)(i.code,{children:"old"}),"/",(0,s.jsx)(i.code,{children:"change"})," ",(0,s.jsx)(i.code,{children:"domain"}),"/",(0,s.jsx)(i.code,{children:"path"})," are now automatically available in the context and a new helper ",(0,s.jsx)(i.code,{children:"ynh_change_url_nginx_config"})," takes care of tweaking the nginx conf. Your script should essentially just call that helper and possibly tweak the app's conf and possibly restart the app's service"]}),"\n",(0,s.jsxs)(i.li,{children:[(0,s.jsxs)(i.strong,{children:["Introduce a new ",(0,s.jsx)(i.code,{children:"resource"})," mechanism"]}),"\n",(0,s.jsxs)(i.ul,{children:["\n",(0,s.jsxs)(i.li,{children:["Resources are declared in the ",(0,s.jsx)(i.code,{children:"manifest.toml"}),"."]}),"\n",(0,s.jsx)(i.li,{children:"They are meant to formalize recurring app needs that are to be provisioned/deprovisioned by the core."}),"\n",(0,s.jsx)(i.li,{children:"They include for example: system user, apt dependencies, install dir, data dir, port, permissions, SQL database..."}),"\n",(0,s.jsxs)(i.li,{children:["Each resource is to be provisioned ",(0,s.jsx)(i.em,{children:"before"})," running the install script, deprovisioned ",(0,s.jsx)(i.em,{children:"after"})," the remove script, and automatically upgraded if needed before running the upgrade script (or provisionned if introduced in the new app version, or deprovisioned if removed w.r.t. the previous app version)"]}),"\n",(0,s.jsx)(i.li,{children:"More infos about resources and their options and behavior are available in the dedicated doc page"}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(i.li,{children:[(0,s.jsxs)(i.strong,{children:["Permissions are automatically initialized using the answer to the ",(0,s.jsx)(i.code,{children:"init_main_permission"})," install question"]})," (replacing the ",(0,s.jsx)(i.code,{children:"is_public"})," question). No need to write a boring ",(0,s.jsx)(i.code,{children:"if $is_public ..."})," in the install script to add visitors anymore ! There is a similar mechanism to init other permissions, eg ",(0,s.jsx)(i.code,{children:"init_admin_permission"})," (cf also the doc about the ",(0,s.jsx)(i.code,{children:"permission"})," resource)"]}),"\n",(0,s.jsxs)(i.li,{children:[(0,s.jsxs)(i.strong,{children:["The content of the ",(0,s.jsx)(i.code,{children:"doc/"})," folder is now meant to be integrated in the webadmin"]})," (though this is still WIP as of writing this). In particular:","\n",(0,s.jsxs)(i.ul,{children:["\n",(0,s.jsxs)(i.li,{children:[(0,s.jsx)(i.code,{children:"DESCRIPTION.md"})," and the ",(0,s.jsx)(i.code,{children:"screenshots/"})," folder are expected to be displayed prior to the app install form (similar to app stores on mobile)"]}),"\n",(0,s.jsxs)(i.li,{children:[(0,s.jsx)(i.code,{children:"ADMIN.md"})," is expected to be made available somewhere in the info page and should contain technical admin notes. Other pages can be defined (just name it ",(0,s.jsx)(i.code,{children:"WHATEVER.md"}),"). Lang codes are also supported following the existing scheme for the README, eg ",(0,s.jsx)(i.code,{children:"README_fr.md"})," is the French version, hence you can create ",(0,s.jsx)(i.code,{children:"ADMIN_fr.md"}),", etc."]}),"\n",(0,s.jsxs)(i.li,{children:["Note that the ",(0,s.jsx)(i.code,{children:"ADMIN.md"})," page supports the ",(0,s.jsx)(i.code,{children:"__FOOBAR__"})," notation that will be automatically replaced with the app's ",(0,s.jsx)(i.code,{children:"foobar"})," setting"]}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(i.li,{children:[(0,s.jsxs)(i.strong,{children:["Special files called 'notifications' are meant to replace the ",(0,s.jsx)(i.code,{children:"ynh_send_readme_to_admin"})," mechanics"]}),". They are also to be added to the ",(0,s.jsx)(i.code,{children:"doc"})," folder:","\n",(0,s.jsxs)(i.ul,{children:["\n",(0,s.jsxs)(i.li,{children:[(0,s.jsx)(i.code,{children:"doc/PRE_INSTALL.md"}),': a note to be displayed prior to the app install. Typically to warn of something unusual, such as "the app install will automatically add 1GB swap to the system".']}),"\n",(0,s.jsxs)(i.li,{children:[(0,s.jsx)(i.code,{children:"doc/POST_INSTALL.md"}),": a note to be displayed after the app install. Typically to explain post-install operations to be performed manually by the admin and that cannot be automated."]}),"\n",(0,s.jsxs)(i.li,{children:[(0,s.jsx)(i.code,{children:"doc/PRE_UPGRADE.md"}),": a note to be displayed prior to any upgrade of this app."]}),"\n",(0,s.jsxs)(i.li,{children:[(0,s.jsx)(i.code,{children:"doc/PRE_UPGRADE.d/{version}.md"}),": a note to be displayed prior to a specific version upgrade."]}),"\n",(0,s.jsxs)(i.li,{children:[(0,s.jsx)(i.code,{children:"doc/POST_UPGRADE.md"}),": a note to be displayed after the app upgrade. For example in the context of Nextcloud, the fact that you may need to re-enable custom modules manually?"]}),"\n",(0,s.jsxs)(i.li,{children:["Note that the notifications, like ",(0,s.jsx)(i.code,{children:"ADMIN.md"}),", supports the ",(0,s.jsx)(i.code,{children:"__FOOBAR__"})," notation that will be automatically replaced with the app's ",(0,s.jsx)(i.code,{children:"foobar"})," setting"]}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(i.li,{children:[(0,s.jsx)(i.strong,{children:"Replace some historical names with more sensible ones"}),", or homogenize some practices:","\n",(0,s.jsxs)(i.ul,{children:["\n",(0,s.jsxs)(i.li,{children:[(0,s.jsx)(i.code,{children:"final_path"})," is now ",(0,s.jsx)(i.code,{children:"install_dir"})," (this migration should be automatically handled by the core and the ",(0,s.jsx)(i.code,{children:"convert_app_to_packaging_v2.py"})," script)"]}),"\n",(0,s.jsxs)(i.li,{children:[(0,s.jsx)(i.code,{children:"datadir"})," is now ",(0,s.jsx)(i.code,{children:"data_dir"})," to be consistent with ",(0,s.jsx)(i.code,{children:"install_dir"})," (this migration should be automatically handled by the core and the ",(0,s.jsx)(i.code,{children:"convert_app_to_packaging_v2.py"})," script)"]}),"\n",(0,s.jsxs)(i.li,{children:[(0,s.jsx)(i.code,{children:"path"})," is now always loaded as ",(0,s.jsx)(i.code,{children:"$path"}),", no funky ",(0,s.jsx)(i.code,{children:"$path_url"}),"-but-it-is-saved-as-",(0,s.jsx)(i.code,{children:"path"})," anymore (this migration should be automatically handled by the core and the ",(0,s.jsx)(i.code,{children:"convert_app_to_packaging_v2.py"})," script)"]}),"\n",(0,s.jsxs)(i.li,{children:[(0,s.jsx)(i.code,{children:"mysqldbpwd"})," and ",(0,s.jsx)(i.code,{children:"psqlpwd"})," or whatever are now always saved as ",(0,s.jsx)(i.code,{children:"db_pwd"})," (cf the ",(0,s.jsx)(i.code,{children:"database"})," resource) (this migration should be automatically handled by the core and the ",(0,s.jsx)(i.code,{children:"convert_app_to_packaging_v2.py"})," script)"]}),"\n",(0,s.jsxs)(i.li,{children:["ports settings are now always named either ",(0,s.jsx)(i.code,{children:"$port"})," or ",(0,s.jsx)(i.code,{children:"$port_foo_bar"})," instead of ",(0,s.jsx)(i.code,{children:"$foo_bar_port"})," (cf the ",(0,s.jsx)(i.code,{children:"port"})," resource) (this migration should be automatically handled by the core and the ",(0,s.jsx)(i.code,{children:"convert_app_to_packaging_v2.py"})," script)"]}),"\n",(0,s.jsxs)(i.li,{children:["the install dir is to be set to ",(0,s.jsx)(i.code,{children:"/var/www/$app"})," by default for web apps (or can be changed to ",(0,s.jsx)(i.code,{children:"/opt/????"})," for non-webapps). Note that YunoHost will ",(0,s.jsx)(i.strong,{children:"automatically move"})," the old install dir to the new ",(0,s.jsx)(i.code,{children:"install_dir"})," during the corresponding upgrade."]}),"\n"]}),"\n"]}),"\n"]})]})}function h(e={}){let{wrapper:i}={...(0,a.R)(),...e.components};return i?(0,s.jsx)(i,{...e,children:(0,s.jsx)(l,{...e})}):l(e)}},4429:function(e,i,n){n.d(i,{R:()=>o,x:()=>r});var t=n(6540);let s={},a=t.createContext(s);function o(e){let i=t.useContext(a);return t.useMemo(function(){return"function"==typeof e?e(i):{...i,...e}},[i,e])}function r(e){let i;return i=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:o(e.components),t.createElement(a.Provider,{value:i},e.children)}}}]);