"use strict";(self.webpackChunkyunohost_docs=self.webpackChunkyunohost_docs||[]).push([["7607"],{1234:function(e,n,s){s.r(n),s.d(n,{frontMatter:()=>o,toc:()=>l,default:()=>h,metadata:()=>i,assets:()=>r,contentTitle:()=>c});var i=JSON.parse('{"id":"packaging/scripts/index","title":"The scripts","description":"App scripts are the essential logic defining what happens when an app is installed, removed, upgraded, backuped, or restored. They are written in Bash) which is the same stuff you type in interactive mode in a terminal, though we added a bunch of custom YunoHost functions that we call helpers to standardize many common operations - for example adding the nginx configuration.","source":"@site/docs/packaging/20.scripts/index.mdx","sourceDirName":"packaging/20.scripts","slug":"/packaging/scripts/","permalink":"/doc/pr-2672/it/packaging/scripts/","draft":false,"unlisted":false,"editUrl":"https://github.com/YunoHost/doc/tree/main/docs/packaging/20.scripts/index.mdx","tags":[],"version":"current","frontMatter":{"title":"The scripts"},"sidebar":"devpackaging","previous":{"title":"App resources","permalink":"/doc/pr-2672/it/packaging/manifest/resources"},"next":{"title":"General scope of variables","permalink":"/doc/pr-2672/it/packaging/scripts/shell_variables_scope"}}'),a=s(4848),t=s(4429);let o={title:"The scripts"},c,r={},l=[{value:"Variables available in a script context",id:"variables-available-in-a-script-context",level:2},{value:"Setting system",id:"setting-system",level:2},{value:"Helper system",id:"helper-system",level:2},{value:"Configuration/template system",id:"configurationtemplate-system",level:2},{value:"App sources",id:"app-sources",level:2},{value:"Common operations (TODO/FIXME)",id:"common-operations-todofixme",level:2},{value:"installing/upgrading app sources",id:"installingupgrading-app-sources",level:3},{value:"adding configurations",id:"adding-configurations",level:3},{value:"adding a systemd service",id:"adding-a-systemd-service",level:3},{value:"curl / automatizing install forms",id:"curl--automatizing-install-forms",level:3},{value:"classic stuff for nodejs apps",id:"classic-stuff-for-nodejs-apps",level:3},{value:"classic stuff for php apps",id:"classic-stuff-for-php-apps",level:3},{value:"classic stuff for python apps",id:"classic-stuff-for-python-apps",level:3},{value:"classic stuff for ??? apps",id:"classic-stuff-for--apps",level:3}];function d(e){let n={a:"a",code:"code",h2:"h2",h3:"h3",li:"li",p:"p",pre:"pre",ul:"ul",...(0,t.R)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsxs)(n.p,{children:["App scripts are the essential logic defining what happens when an app is ",(0,a.jsx)(n.code,{children:"install"}),"ed, ",(0,a.jsx)(n.code,{children:"remove"}),"d, ",(0,a.jsx)(n.code,{children:"upgrade"}),"d, ",(0,a.jsx)(n.code,{children:"backup"}),"ed, or ",(0,a.jsx)(n.code,{children:"restore"}),"d. They are written in ",(0,a.jsx)(n.a,{href:"https://en.wikipedia.org/wiki/Bash_(Unix_shell)",children:"Bash"})," which is the same stuff you type in interactive mode in a terminal, though we added a bunch of custom YunoHost functions that we call ",(0,a.jsx)(n.code,{children:"helpers"})," to standardize many common operations - for example adding the nginx configuration."]}),"\n",(0,a.jsxs)(n.p,{children:["Note that starting from packaging v2, the logic or what happens when an app is installed, etc. is also contained partially in the resource configuration in the ",(0,a.jsx)(n.code,{children:"manifest.toml"}),"."]}),"\n",(0,a.jsxs)(n.p,{children:["In the ",(0,a.jsx)(n.code,{children:"scripts"})," folder of an app, you can expect to find:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-text",children:'manifest.toml\nscripts\n\u251C\u2500\u2500 _common.sh  # Some "common" definition, typically custom helpers \n\u2502               # or global variables used accross all scripts\n\u251C\u2500\u2500 install     # The install procedure\n\u251C\u2500\u2500 remove      # The remove procedure\n\u251C\u2500\u2500 backup      # The backup procedure - in fact it only "declares" what should be backed up.\n\u2502               # No actual real backup happens at this point except dumping SQL databases\n\u251C\u2500\u2500 restore     # The restore procedure\n\u251C\u2500\u2500 change_url  # Some apps do also provide a change url script, which corresponds to changing\n\u2502               # the URL endpoint of the app, which may be as simple as changing\n\u2502               # the nginx conf, or may involve significant changes in the app DB\n\u2514\u2500\u2500 upgrade     # The upgrade procedure\n'})}),"\n",(0,a.jsxs)(n.p,{children:["Here is an example of the simple install script for the ",(0,a.jsx)(n.code,{children:"helloworld"})," app:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:'#!/bin/bash\n\n# This is where we load the official YunoHost helpers\nsource /usr/share/yunohost/helpers\n\n#=================================================\n# DOWNLOAD, CHECK AND UNPACK SOURCE\n# This is where we would usually fetch the .tar.gz archive \n# from the upstream and extract it into our local install dir\n#=================================================\n# At the beginning of each major operation, we call this helper\n# that creates a progress bar\nynh_script_progression --message="Setting up source files..." --weight=1\n\necho "Hello world!" > $install_dir/index.html\nchown -R www-data: "$install_dir"\n\n#=================================================\n# NGINX CONFIGURATION\n# This is where the nginx conf snippet for the app is created using the\n# configuration template provided in conf/nginx.conf\n# and added to /etc/nginx/conf.d/$domain.d/$app.conf\n#=================================================\nynh_script_progression --message="Configuring nginx web server..." --weight=1\n\nynh_add_nginx_config\n'})}),"\n",(0,a.jsxs)(n.p,{children:["Note that the scripts are run with the ",(0,a.jsx)(n.code,{children:"set -eu"})," options (except for the remove script), which means that any failing command or use of non-existing variable will trigger an error and stop the script execution."]}),"\n",(0,a.jsx)(n.h2,{id:"variables-available-in-a-script-context",children:"Variables available in a script context"}),"\n",(0,a.jsx)(n.p,{children:"Special variables are automatically defined in the context of a script:"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.code,{children:"$app"})," is the app ID. It will typically be the ID from the app's manifest.toml, for example ",(0,a.jsx)(n.code,{children:"helloworld"}),", but will be ",(0,a.jsx)(n.code,{children:"helloworld__2"}),", ",(0,a.jsx)(n.code,{children:"__3"})," etc for multi-instance installs."]}),"\n",(0,a.jsxs)(n.li,{children:["During install, answers to install questions are automatically available as bash variables. Typically, ",(0,a.jsx)(n.code,{children:"$domain"})," and ",(0,a.jsx)(n.code,{children:"$path"})," will contain the answers to the default install questions assuming they are defined in the ",(0,a.jsx)(n.code,{children:"manifest.toml"}),". Answer values associated to any custom install questions will be available the same way, e.g. ",(0,a.jsx)(n.code,{children:"$prefered_pet"})," for the custom question ",(0,a.jsx)(n.code,{children:"[install.prefered_pet]"})," that would be defined in the manifest. Note that - apart from special questions such as ",(0,a.jsx)(n.code,{children:"init_main_permission"})," or user-provided passwords - they are also automatically saved as settings (cf. next section)."]}),"\n",(0,a.jsx)(n.li,{children:"During other scripts, all app settings are also loaded and automatically available."}),"\n",(0,a.jsxs)(n.li,{children:["Note that some settings are automatically created/updated by app ressources. For example, the ",(0,a.jsx)(n.code,{children:"install_dir"})," setting will automatically be available too and corresponds to typically ",(0,a.jsx)(n.code,{children:"/var/www/$app"})]}),"\n",(0,a.jsxs)(n.li,{children:["In the ",(0,a.jsx)(n.code,{children:"change_url"})," context, variables called ",(0,a.jsx)(n.code,{children:"new_domain"}),", ",(0,a.jsx)(n.code,{children:"new_path"}),", ",(0,a.jsx)(n.code,{children:"old_domain"}),", ",(0,a.jsx)(n.code,{children:"old_path"})," will be available, as well as ",(0,a.jsx)(n.code,{children:"change_domain"})," and ",(0,a.jsx)(n.code,{children:"change_path"})," equal to ",(0,a.jsx)(n.code,{children:"0"})," (false) or ",(0,a.jsx)(n.code,{children:"1"})," (true) depending if the domain / path changed"]}),"\n"]}),"\n",(0,a.jsx)(n.h2,{id:"setting-system",children:"Setting system"}),"\n",(0,a.jsxs)(n.p,{children:['Application often need to store long term information in between scripts triggered by the admin. For this, YunoHost has a key-value store for each application called "setting" and is stored in ',(0,a.jsx)(n.code,{children:"/etc/yunohost/apps/$app/settings.yml"}),"."]}),"\n",(0,a.jsx)(n.p,{children:"Apps can interact with this key value store in this way:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:'# Retrieve a setting into variable "db_name"\ndb_name=$(ynh_app_setting_get --app=$app --key=db_name)\n\n# Update a setting\nynh_app_setting_set --app=$app --key=db_name --value=$db_name\n'})}),"\n",(0,a.jsx)(n.h2,{id:"helper-system",children:"Helper system"}),"\n",(0,a.jsxs)(n.p,{children:["We call helpers a set of custom bash function created by the YunoHost project to standardize common operations accross all apps. They are all prefixed with ",(0,a.jsx)(n.code,{children:"ynh_"}),". The full list and documentation of these helpers is available on ",(0,a.jsx)(n.a,{href:"/packaging/scripts/helpers_v2.1",children:"this page"}),". Some of these helpers are now partially obsolete as they are now handled by the core via app resources."]}),"\n",(0,a.jsx)(n.p,{children:"Here is the list of the major ones:"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.code,{children:"ynh_app_setting_get"})," / ",(0,a.jsx)(n.code,{children:"ynh_app_setting_set"})]}),"\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.code,{children:"ynh_script_progression"})}),"\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.code,{children:"ynh_setup_source"})}),"\n",(0,a.jsxs)(n.li,{children:["nginx: ",(0,a.jsx)(n.code,{children:"ynh_add_nginx_config"})," / ",(0,a.jsx)(n.code,{children:"ynh_remove_nginx_config"})]}),"\n",(0,a.jsxs)(n.li,{children:["php: ",(0,a.jsx)(n.code,{children:"ynh_add_fpm_config"})," / ",(0,a.jsx)(n.code,{children:"ynh_remove_fpm_config"})]}),"\n",(0,a.jsxs)(n.li,{children:["systemd: ",(0,a.jsx)(n.code,{children:"ynh_add_systemd_config"})," / ",(0,a.jsx)(n.code,{children:"ynh_remove_systemd_config"})]}),"\n",(0,a.jsxs)(n.li,{children:["fail2ban: ",(0,a.jsx)(n.code,{children:"ynh_add_fail2ban_config"})," / ",(0,a.jsx)(n.code,{children:"ynh_remove_fail2ban_config"})]}),"\n",(0,a.jsxs)(n.li,{children:["custom: ",(0,a.jsx)(n.code,{children:"ynh_add_config"})]}),"\n",(0,a.jsxs)(n.li,{children:["nodejs: ",(0,a.jsx)(n.code,{children:"ynh_install_nodejs"})," / ",(0,a.jsx)(n.code,{children:"ynh_use_nodejs"})]}),"\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.code,{children:"ynh_exec_warn_less"})}),"\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.code,{children:"ynh_local_curl"})}),"\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.code,{children:"ynh_secure_remove"})}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.code,{children:"ynh_backup"})," / ",(0,a.jsx)(n.code,{children:"ynh_restore_file"})]}),"\n"]}),"\n",(0,a.jsx)(n.h2,{id:"configurationtemplate-system",children:"Configuration/template system"}),"\n",(0,a.jsx)(n.p,{children:"App scripts will often need to create a bunch of configuration files."}),"\n",(0,a.jsxs)(n.p,{children:["Configuration templates are canonically stored provided in the ",(0,a.jsx)(n.code,{children:"conf/"})," folder of the app, such as ",(0,a.jsx)(n.code,{children:"nginx.conf"}),", ",(0,a.jsx)(n.code,{children:"extra_php-fpm.conf"}),", ",(0,a.jsx)(n.code,{children:"systemd.conf"}),", or ",(0,a.jsx)(n.code,{children:"some-custom-app-conf.env"})," ..."]}),"\n",(0,a.jsxs)(n.p,{children:["In these templates, you can use the syntax ",(0,a.jsx)(n.code,{children:"__FOOBAR__"})," which will automatically be replaced by the variable ",(0,a.jsx)(n.code,{children:"$foobar"})," during runtime, when the conf is installed via the ",(0,a.jsx)(n.code,{children:"ynh_add_*_config"})," helpers."]}),"\n",(0,a.jsx)(n.p,{children:"For example, an app's NGINX conf snippet may look like:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-text",children:"# The next line starting with '#sub_path_only' is automatically uncommented only when $path is not /\n#sub_path_only rewrite ^__PATH__$ __PATH__/ permanent;\nlocation __PATH__/ {\n\n  alias __INSTALL_DIR__/;\n\n  # Some headers and tweaks\n\n}\n"})}),"\n",(0,a.jsx)(n.h2,{id:"app-sources",children:"App sources"}),"\n",(0,a.jsxs)(n.p,{children:["App sources were historically defined in ",(0,a.jsx)(n.code,{children:"conf/app.src"})," files containing the URL + checksum of assets to download."]}),"\n",(0,a.jsxs)(n.p,{children:["This is now integrated in ",(0,a.jsx)(n.code,{children:"manifest.toml"})," using the ",(0,a.jsx)(n.code,{children:"sources"})," resource, which pre-download the assets prior to entering the install or upgrade scripts. The sources can then be effectively deployed using ",(0,a.jsx)(n.code,{children:"ynh_setup_source"}),"."]}),"\n",(0,a.jsxs)(n.p,{children:["For example, for YesWiki, the sources are defined in ",(0,a.jsx)(n.code,{children:"manifest.toml"})," using:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-toml",children:'[resources.sources.main]\nurl = "https://github.com/YesWiki/yeswiki/archive/refs/tags/v4.4.0.tar.gz"\nsha256 = "5ceb12d225c20de2ba3cb4ce483348ed1a8ad5b1789d4f4f8f89dc4871524007"\n'})}),"\n",(0,a.jsxs)(n.p,{children:["More infos on the ",(0,a.jsx)(n.code,{children:"source"})," resource in ",(0,a.jsx)(n.a,{href:"/packaging/manifest/resources",children:"the resource system documentation"}),"."]}),"\n",(0,a.jsx)(n.h2,{id:"common-operations-todofixme",children:"Common operations (TODO/FIXME)"}),"\n",(0,a.jsx)(n.h3,{id:"installingupgrading-app-sources",children:"installing/upgrading app sources"}),"\n",(0,a.jsx)(n.h3,{id:"adding-configurations",children:"adding configurations"}),"\n",(0,a.jsx)(n.h3,{id:"adding-a-systemd-service",children:"adding a systemd service"}),"\n",(0,a.jsx)(n.h3,{id:"curl--automatizing-install-forms",children:"curl / automatizing install forms"}),"\n",(0,a.jsx)(n.h3,{id:"classic-stuff-for-nodejs-apps",children:"classic stuff for nodejs apps"}),"\n",(0,a.jsx)(n.h3,{id:"classic-stuff-for-php-apps",children:"classic stuff for php apps"}),"\n",(0,a.jsx)(n.h3,{id:"classic-stuff-for-python-apps",children:"classic stuff for python apps"}),"\n",(0,a.jsx)(n.h3,{id:"classic-stuff-for--apps",children:"classic stuff for ??? apps"})]})}function h(e={}){let{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,a.jsx)(n,{...e,children:(0,a.jsx)(d,{...e})}):d(e)}},4429:function(e,n,s){s.d(n,{R:()=>o,x:()=>c});var i=s(6540);let a={},t=i.createContext(a);function o(e){let n=i.useContext(t);return i.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:o(e.components),i.createElement(t.Provider,{value:n},e.children)}}}]);